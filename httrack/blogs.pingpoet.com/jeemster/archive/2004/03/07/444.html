

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
	
<!-- Mirrored from blogs.pingpoet.com/jeemster/archive/2004/03/07/444.aspx by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 07 May 2018 04:37:43 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head><title>
	Windows and TCP/IP Ports and Availability
</title><meta http-equiv="content-type" content="text/html; charset=UTF-8" /><meta name="author" content="jeemster" /><meta name="Generator" content="Subtext Version 1.9.4.78" /><link id="RSSLink" title="RSS" type="application/rss+xml" rel="alternate" href="../../../../Rss.aspx" /><link type="text/css" rel="stylesheet" href="../../../../../skins/_System/csharp.css"></link>
<link type="text/css" rel="stylesheet" href="../../../../../skins/_System/commonstyle.css"></link>
<link type="text/css" rel="stylesheet" href="../../../../../skins/_System/commonlayout.css"></link>
<link type="text/css" rel="stylesheet" href="../../../../../Skins/RedBook/niceforms-default.css"></link>
<link media="print" type="text/css" rel="stylesheet" href="../../../../../Skins/RedBook/print.css"></link>
<link id="MainStyle" type="text/css" rel="stylesheet" href="../../../../../skins/RedBook/style.css" /><link id="SecondaryCss" type="text/css" rel="stylesheet" href="../../../../../skins/RedBook/Blue.css" /><link id="Rsd" rel="EditURI" type="application/rsd+xml" title="RSD" href="../../../../rsd.xml.ashx" /><link id="AtomLink" title="RSS" type="application/rss+xml" rel="alternate" href="../../../../Rss.aspx" /><script src="../../../../../Scripts/common.js" type="text/javascript"></script><script src="../../../../../Scripts/tableEffects.js" type="text/javascript"></script><script src="../../../../../Scripts/BlogInfo.js" type="text/javascript"></script>
		<script type="text/javascript">
			var subtextAllowedHtmlTags = ['a', 'b', 'strong', 'blockquote', 'i', 'em', 'u', 'strike', 'super', 'sub', 'code'];
			var subtextBlogInfo = new blogInfo('../../../../../index.html', '/jeemster/" />');
		</script>
		<script type="text/javascript" src="../../../../../Admin/Resources/Scripts/niceForms.js"></script>
<link rel="pingback" href="../../../../Services/Pingback.html"></link></head>
	<body>
		<form name="Form1" method="post" action="http://blogs.pingpoet.com/jeemster/archive/2004/03/07/444.aspx" id="Form1">
<div>
<input type="hidden" name="PostComment_ascx_ctl00_answer" id="PostComment_ascx_ctl00_answer" value="" />
<input type="hidden" name="__EVENTTARGET" id="__EVENTTARGET" value="" />
<input type="hidden" name="__EVENTARGUMENT" id="__EVENTARGUMENT" value="" />
<input type="hidden" name="__VIEWSTATE" id="
__VIEWSTATE" value="" />
</div>

<script type="text/javascript">
//<![CDATA[
var theForm = document.forms['Form1'];
if (!theForm) {
    theForm = document.Form1;
}
function __doPostBack(eventTarget, eventArgument) {
    if (!theForm.onsubmit || (theForm.onsubmit() != false)) {
        theForm.__EVENTTARGET.value = eventTarget;
        theForm.__EVENTARGUMENT.value = eventArgument;
        theForm.submit();
    }
}
//]]>
</script>


<script src="../../../../../WebResourceca6f.js?d=vT1yz21OBJxBgCt3OM9vt4Y4jX88BPYiwkNtAfZuXqXphi6ccxTRjVFJnDscDk1pKotIsoE5gziAablpwXXNVTZ1pNg1&amp;t=635294807132453548" type="text/javascript"></script>

<div>

	<input type="hidden" name="__SCROLLPOSITIONX" id="__SCROLLPOSITIONX" value="0" />
	<input type="hidden" name="__SCROLLPOSITIONY" id="__SCROLLPOSITIONY" value="0" />
	<input type="hidden" name="__EVENTVALIDATION" id="__EVENTVALIDATION" value="/wEWAgL+raDpAgL+3ZGoBO7/ic8PB5Sp16LSse5CbSzcbwud" />
</div>
			
<div id="rondo"><p>&nbsp;</p></div>
		<div id="all">
			
<div id="hd">
	<div id="header">
		<h1><a id="header_HeaderTitle" title="The Title Of This Blog." href="../../../../Default.html">jeemsters</a></h1>
		<div>brain chaos</div>
	</div>
</div>

			
<div id="blogstats">
	<div>
	<span>Blog Stats</span>
	<ul>
		<li>Posts - 31</li>
		<li>Articles - 0</li>
		<li>Comments - 1</li>
		<li>Trackbacks - 680</li>
	</ul>
	</div>
</div>
<div id="blogstatsback">
<p>&nbsp;</p>
</div>
			<div id="navigation">
					
<ul>
	<li><a id="MyLinks_HomeLink" title="Link to the home page." href="../../../../Default.html">Home</a></li>
	<li><a id="MyLinks_Archives" title="View Archives." href="../../../../archives.html">Archives</a></li>
	<li><a id="MyLinks_ContactLink" accesskey="9" title="Contact form." href="../../../../contact.html">Contact</a></li>
	<li><a id="MyLinks_Admin" title="Login Form." href="../../../../login.html">Login</a></li>
</ul>

<!-- Not Visible -->



			</div>
			<div id="container">
				<div id="content">
						
					
<div class="previousNext">
	<a id="viewpost_ascx_PreviousNext_PrevLink" title="previous post" href="../../02/25/398.html"><< Livelink</a>
	<span id="viewpost_ascx_PreviousNext_LeftPipe" class="prevNextSeparator"> | </span>
	<a id="viewpost_ascx_PreviousNext_MainLink" href="../../../../Default.html">Home</a>
	<span id="viewpost_ascx_PreviousNext_RightPipe" class="prevNextSeparator"> | </span>
	<a id="viewpost_ascx_PreviousNext_NextLink" title="next post" href="../14/458.html">Market Consolidation ... >></a>
</div>


<div class="journal_eintrag">
	<h2><a id="viewpost_ascx_TitleUrl" class="singleposttitle" title="Title of this entry." href="444.html">Windows and TCP/IP Ports and Availability</a></h2>
	<P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Something interesting I ran into working on a recent project.</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><?xml:namespace prefix = o ns = "urn:schemas-microsoft-com:office:office" /><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Intermittently, we&nbsp;would get&nbsp;connection errors&nbsp;over the network. After some debugging on the issue we found out some interesting items relating to the TCP/IP stack on Windows servers and clients.</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><STRONG><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Some background details on TCP/IP</SPAN></STRONG><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">A TCP/IP connection consists of two endpoints, and each endpoint consists of an IP address and a port number. </SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Someone used an analogy of the IP address tells you the street address and the port address is the apartment in the building.</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Anyhow, when a client connects to a server, the established connection can be thought of as being uniquely identified by&nbsp;four (4) pieces of information. The&nbsp;four pieces are:<o:p></o:p></SPAN></P><UL><LI><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">The server IP Address<o:p></o:p></SPAN></LI><LI><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">The server port<o:p></o:p></SPAN></LI><LI><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">The client IP Address<o:p></o:p></SPAN></LI><LI><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">The client port <o:p></o:p></SPAN></LI></UL><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">If all of these are the same, at the same time, this is what constitutes a connection.</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">When a connection is initiated we know three of the four pieces of information. We know:</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><UL type=disc><LI class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto; mso-list: l0 level1 lfo1; tab-stops: list .5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Server IP Address (or DNS that results to an IP Address)</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></LI><LI class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto; mso-list: l0 level1 lfo1; tab-stops: list .5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">The <?xml:namespace prefix = st1 ns = "urn:schemas-microsoft-com:office:smarttags" /><st1:place w:st="on"><st1:PlaceName w:st="on">server</st1:PlaceName> <st1:PlaceType w:st="on">Port</st1:PlaceType></st1:place> (that typically relates to the protocol, like HTTP)</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></LI><LI class=MsoNormal style="MARGIN: 0in 0in 0pt; mso-margin-top-alt: auto; mso-margin-bottom-alt: auto; mso-list: l0 level1 lfo1; tab-stops: list .5in"><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">The Client IP Address</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></LI></UL><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">So, the only unknown is the client port.</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">This client port is retrieved from a designated range of <A href="http://www.ncftpd.com/ncftpd/doc/misc/ephemeral_ports.html">Ephemeral ports</A> which are temporary ports assigned by a machine's IP stack. On Windows, which uses the uses the traditional BSD&nbsp;range of Ephemeral ports is limited to between 1024 and MaxUserPort (default=5000). This means that the client can only have 3975 connections open at any one time to any specified service. When the connection terminates, the ephemeral port is available for reuse, following the TIME_WAIT period.</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">To further complicate the issue, as defined in the original <A href="http://www.ietf.org/rfc/rfc0793.txt?number=793">TCP RFC</A>, after a connection has been closed it is required to remain in the TIME_WAIT state for twice the MSL (<!--StartFragment -->maximum segment lifetime) once the connection is completely closed at both ends. This implies that the TIME_WAIT state with the original TCP is 240 seconds.</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Note: I found&nbsp;some implementations of TCP have the TIME_WAIT set to 60 seconds. Stevens ([<A href="http://www.amazon.com/exec/obidos/tg/detail/-/0201633469/qid=1078664020/sr=1-1/ref=sr_1_1/102-8529815-0220158?v=glance&amp;s=books#product-details">STEVENS] page 54</A>) shows how the TIME_WAIT state for TCP may be shortened to 12 seconds. </SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Therefore, if the TCP/IP defaults are used, a client can only average 16 connections per second (3975/240) to&nbsp;a specified server service before all of the available ephemeral ports will be used up and connections will not be possible.</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Normally, this would not be an issue as most protocols will us the same connection for the life of a conversation. However, in testing environments and some, stateless protocols, where high volumes of connections are required, these numbers can be reached easily with modern hardware and networks.</SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">To work around these limitations,&nbsp;you can either increase the <A href="http://support.microsoft.com/default.aspx?scid=kb%3Ben-us%3B196271">MaxUserPort</A> or decrease the <A href="http://support.microsoft.com/default.aspx?scid=kb;EN-US;149532">TcpTimedWaitDelay</A> (TIME_WAIT)&nbsp;or both on the <STRONG><I><SPAN style="FONT-FAMILY: Arial">client machine</SPAN></I></STRONG>. We found reducing the TIME_WAIT works best for most enterprise environments. </SPAN><SPAN style="FONT-SIZE: 9pt; FONT-FAMILY: Arial"><o:p></o:p></SPAN></P><P><SPAN style="FONT-SIZE: 10pt; FONT-FAMILY: Arial">Try reducing it in small increments and do not go crazy as this number is there for you could cause much greater issues if you had get messages from a previous connection intermingled with a new session.</SPAN></P>

		<p class="postfooter">
			<a href="javascript:window.print();" class="printIcon"><span>Print</span></a>
			posted @ Sunday, March 07, 2004 8:01 AM
		</p>
		</div>
	
<!--
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
xmlns:dc="http://purl.org/dc/elements/1.1/"
xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/">
<rdf:Description
rdf:about="http://blogs.pingpoet.com/jeemster/archive/2004/03/07/444.aspx"
dc:identifier="http://blogs.pingpoet.com/jeemster/archive/2004/03/07/444.aspx"
dc:title="Windows and TCP/IP Ports and Availability"
trackback:ping="http://blogs.pingpoet.com/jeemster/services/trackbacks/444.aspx" />
</rdf:RDF>
-->
<span id='apnlCommentsWrapper$RBS_Holder'><span id="apnlCommentsWrapper" AjaxCall="async">
<hr/>
<a id="feedback" title="feedback anchor"></a>
<div id="moreinfo">
	<h2>Feedback</h2>

	    <p></p>
	    
			    <div class="comment">
				    
				    <h4>
					    <a title="permalink: re: Windows and TCP/IP Ports and Availability" href="444.html#34">#</a>&nbsp;<a name="34"></a>re: Windows and TCP/IP Ports and Availability
				    </h4>
				    I don't think many people know about such low level protocol details of windows, I know I didn't. Very informative article. Keep these great posts coming! Thanks!
				    <span class="commentInfo">3/7/2004 2:02 PM | <cite><a id="Comments_ascx_CommentList_ctl00_NameLink" title="PingBack/TrackBack" href="../../../../../overflow/index.html" target="_blank">Scott Willeke</a></cite></span>
				    <a id="Comments_ascx_CommentList_ctl00_EditLink" href="javascript:__doPostBack('Comments_ascx$CommentList$ctl00$EditLink','')"></a>
			    </div>
		    

</div>
<hr/>
<div class="commentsClosedMessage"><span style="font-style: italic;">Comments have been closed on this topic.</span></div></span></span>
				
				</div>
				<div id="rightbar">
					
					
<div id="recentComments">
<h3>Recent Comments</h3>

              <ul>
       
              <li><a id="RecentComments_feedList_ctl01_Link" title="Reader Comment." href="../../../2006/12/07/Address-Books-How-Many-do-You-have.html#29442">Nice post, keep it up , blog is also very good</a><br />by Marky</li>
       
              </ul>
       
</div>
					
		<div class="leftbox">
			<h2>Archives</h2>
			
					<div>
						<ul class="sidebarlist">
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl01_Link" title="" href="../../../2007/02.html">February, 2007 (1)</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl02_Link" title="" href="../../../2006/12.html">December, 2006 (1)</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl03_Link" title="" href="../../../2006/07.html">July, 2006 (1)</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl04_Link" title="" href="../../../2006/01.html">January, 2006 (1)</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl05_Link" title="" href="../../../2005/11.html">November, 2005 (1)</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl06_Link" title="" href="../../../2005/08.html">August, 2005 (1)</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl07_Link" title="" href="../../../2005/03.html">March, 2005 (9)</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl08_Link" title="" href="../../../2005/02.html">February, 2005 (1)</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl09_Link" title="" href="../../06.html">June, 2004 (1)</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl10_Link" title="" href="../../04.html">April, 2004 (1)</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl11_Link" title="" href="../../03.html">March, 2004 (9)</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl00_LinkList_ctl12_Link" title="" href="../../02.html">February, 2004 (4)</a></li>
				
						</ul>
					</div>
				
		</div>
	
		<div class="leftbox">
			<h2>Post Categories</h2>
			
					<div>
						<ul class="sidebarlist">
				
							<li><a id="SingleColumn_Categories_CatList_ctl01_LinkList_ctl01_Link" title="" href="../../../../category/20.html">Chaos</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl01_LinkList_ctl02_Link" title="" href="../../../../category/19.html">Geek Stuff</a></li>
				
							<li><a id="SingleColumn_Categories_CatList_ctl01_LinkList_ctl03_Link" title="" href="../../../../category/22.html">Things from the Job</a></li>
				
						</ul>
					</div>
				
		</div>
	

<div class="leftbox">
	<h2>Syndication:</h2>
	<ul>
	<li><a id="SingleColumn_links_Syndication" title="Subscribe to this feed." href="../../../../Rss.aspx">RSS</a></li>
	<li><a id="SingleColumn_links_AtomLink" title="Subscribe to this feed." href="../../../../Atom.aspx">ATOM</a></li>
	</ul>
</div>

<!-- Not Visible -->








					<div class="leftbox">
						<h2>Hosted by</h2>
						<p class="subtextlogo">
							<a href="http://www.subtextproject.com/" title="Subtext Project Homepage"><img src="../../../../../Images/PoweredBySubtext85x33-2.png" alt="Subtext Blog" /></a>
						</p>
					</div>
				</div>
				<div class="clear"><span></span>&nbsp;</div>	
			</div>
			<div id="footer"><p>&nbsp;</p></div>
		</div>
		<div id="rondobottom"><p>&nbsp;</p></div>
		
<div id="poweredby">
	Copyright &copy; jeemster
</div>

		

<script type="text/javascript">
//<![CDATA[

theForm.oldSubmit = theForm.submit;
theForm.submit = WebForm_SaveScrollPositionSubmit;

theForm.oldOnSubmit = theForm.onsubmit;
theForm.onsubmit = WebForm_SaveScrollPositionOnSubmit;
//]]>
</script>
</form>
	</body>

<!-- Mirrored from blogs.pingpoet.com/jeemster/archive/2004/03/07/444.aspx by HTTrack Website Copier/3.x [XR&CO'2014], Mon, 07 May 2018 04:37:43 GMT -->
</html>
